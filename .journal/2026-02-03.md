# 2026-02-03

## 21:50 - Fixed pkg Binary Build Error in Tauri Demo

**Core Issue**: The Node.js sidecar binary was failing at runtime with `Error: UNEXPECTED-20` when built with `pkg`. The error occurred because `pkg` couldn't properly handle ESM format with `import.meta.url` and dynamic chunk loading.

### Error Details

```
Error: UNEXPECTED-20
    at readFileFromSnapshot (pkg/prelude/bootstrap.js:1070:16)
    at Object.readFileSync (pkg/prelude/bootstrap.js:1094:18)
```

### Root Causes Identified

1. **ESM `import.meta.url` incompatibility**: The bundled code contained `import.meta.url` which pkg has trouble snapshotting
2. **Code splitting creating multiple chunks**: `Bun.build()` with `splitting: true` created separate chunk files that weren't included in the pkg snapshot
3. **External file import**: `node.ts` imported `package.json` from outside the project using `with { type: "json" }` syntax

### Options Considered

1. **Use `--assets` flag with pkg**: Tried including external files in the snapshot, but didn't work with `import.meta.url`
2. **Copy package.json into build directory**: Would require modifying the import path in source code
3. **Build as CommonJS (CJS) format**: Eliminates `import.meta.url` and produces a single file bundle
4. **Upgrade to latest pkg (6.12.0)**: Network issues prevented downloading prebuilt Node.js binaries, causing compilation from source (very slow)

### Final Decision & Rationale

**Chosen approach**: Build as CommonJS format using `bun build --format=cjs`

**Why**:

- CJS format eliminates `import.meta.url` entirely
- Single-file output (no code splitting needed)
- Works reliably with pkg 6.3.2 (stable version)
- Minimal code changes required
- Fast build times (no Node.js compilation from source)

### Key Changes Made

**File: `examples/tauri-demo/build.ts`**

- Changed from `Bun.build({ splitting: true })` to `bun build --format=cjs --target=node`
- This produces a single CommonJS file without `import.meta.url`

**File: `examples/tauri-demo/src/backend/node.ts`**

- Removed problematic `package.json` import: `import pkg from "..." with { type: "json" }`
- Removed `--version` flag handling (non-essential feature)
- Binary now starts without external file dependencies

**File: `examples/tauri-demo/package.json`**

- Pinned `@yao-pkg/pkg` to exact version `6.3.2` (removed `^`)
- Latest 6.12.0 has network/cache issues causing slow Node.js compilation from source

### Verification

Binary now runs successfully:

```bash
./src-tauri/binaries/node-aarch64-apple-darwin
# Output: Node process starts
#         Server is running
```

### Future Considerations

1. **Version flag**: Could re-add `--version` support by hardcoding version or using build-time environment variable
2. **pkg upgrade**: Monitor @yao-pkg/pkg releases for network/cache fix; upgrade when stable
3. **ESM support**: If pkg improves ESM support in future, could revert to ESM format for better tree-shaking

### Files Modified

- `examples/tauri-demo/build.ts`
- `examples/tauri-demo/src/backend/node.ts`
- `examples/tauri-demo/package.json`
