# 2026-02-07

## 00:20 — Request Timeout + Type Safety Cleanup (PLANNING.md items 3 & 4c)

### Core Decision/Topic

Implemented two features from the improvement roadmap: **Request Timeout** (item 3) and **Proxy Type Safety — any-to-unknown cleanup** (item 4c). These were chosen as the two simplest, standalone tasks to tackle first.

### Options Considered

**Request Timeout:**
- Per-call timeout (e.g. `api.slowOp.$timeout(60_000).call(...)`) vs global channel timeout — chose **global timeout** as the simpler first step. Per-call can be added later.
- Timer storage: `Map` vs plain `Record` — used `Record` to match existing `pendingRequests` pattern.

**Type Safety (4c):**
- Full `any` → `unknown` conversion vs targeted cleanup — chose **targeted**. Many `any` usages are intentional escape hatches for dynamic RPC wire data:
  - `PendingRequest.resolve: (result: any)` — changing to `unknown` causes cascading type errors due to Promise contravariance. The `callMethod` return type would need to become `Promise<unknown>`, breaking the public API.
  - `args: any[]` in `callMethod` — changing breaks `callbackCache.get(arg)` since `Map<CallbackFunction, string>.get()` expects `CallbackFunction`, not `unknown`.
  - `let target: any` in object traversal — needed for dynamic property access on arbitrary API shapes.
- Decided to only change what's **safe and non-breaking**: `CallbackFunction` params, catch blocks, and the `isDestroyed` cast.

### Final Decision & Rationale

**Timeout:** Simple timer-per-pending-request pattern. `startTimeout()`/`clearTimeout()` helpers centralize the logic. `destroy()` now rejects all pending requests (previously they'd hang forever if the channel was torn down). `RPCTimeoutError` follows the same pattern as `RPCValidationError` — custom properties survive `serializeError` round-trip, type guard uses `.name` (not `instanceof`) for wire compatibility.

**Type Safety:** Changed 3 categories:
1. `CallbackFunction(...args: unknown[])` — args come from the wire, are truly unknown at runtime
2. `catch (error: unknown)` with `error instanceof Error ? error : new Error(String(error))` — forces proper narrowing instead of silently passing `any` to `sendError`
3. `(this.io as Record<string, unknown>).isDestroyed` — more precise than `as any`

### Key Changes Made

| File | Change |
|---|---|
| `packages/kkrpc/src/channel.ts` | Added `RPCTimeoutError`, `isRPCTimeoutError()`, `timeout` option, `pendingTimers` map, `startTimeout()`/`clearTimeout()` helpers, timer in all 4 call methods, timer clearing in `handleResponse()`, pending-reject in `destroy()`. Changed `CallbackFunction` to `unknown[]`, 5 catch blocks to `error: unknown`, `isDestroyed` cast. |
| `packages/kkrpc/__tests__/timeout.test.ts` | 8 new tests: unit tests for RPCTimeoutError + integration over WebSocket (fast pass, slow timeout, nested timeout, no-timeout default, destroy-rejects-pending) |
| `PLANNING.md` | Marked items 3 and 4c as done |

### Future Considerations

- **Per-call timeout** — could add `$timeout()` modifier on the proxy, or accept timeout in a call options object
- **Task 4a (recursive path types)** — would make `callMethod("math.grade1.add", [1, 2])` fully type-checked internally, but complex TS gymnastics risk confusing error messages. Deferred.
- **Remaining roadmap:** Middleware/Interceptors (item 1), Streaming/Subscriptions (item 2) still pending
