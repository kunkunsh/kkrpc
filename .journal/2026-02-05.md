# Journal Entry - 2026-02-05

## 11:25 - Fixed Python RPC Server Callback Closure Bug

**Core Decision/Topic**: Fixed a critical Python closure bug in the kkrpc Python interop server that caused multiple callbacks in a single RPC request to all route to the same callback ID.

**Problem Analysis**:
The `_wrap_callbacks` method in `interop/python/kkrpc/server.py` creates callback wrapper functions inside a loop. The original code had a classic Python "late binding closure" issue where the `_callback` function captured `callback_id` by reference rather than by value. When a request contained multiple callback arguments, all generated callback functions would reference the same variable, and by the time any callback was invoked, `callback_id` would hold the value from the last iteration of the loop.

**Options Considered**:

1. Use a factory function to create closures with proper binding
2. Use `functools.partial` to bind the callback_id
3. Use default parameter binding (`_callback_id: str = callback_id`) - **Chosen**

**Final Decision & Rationale**:
Selected option 3 (default parameter binding) because:

- It's the most Pythonic and idiomatic solution
- Minimal code change - only adds a default parameter
- No additional imports or helper functions needed
- Default arguments are evaluated at function definition time, capturing the correct value
- Clear and maintainable for future developers

**Key Changes Made**:

- Modified `interop/python/kkrpc/server.py`, lines 63-73
- Changed `def _callback(*callback_args: Any) -> None:` to `def _callback(*callback_args: Any, _callback_id: str = callback_id) -> None:`
- Updated the method reference from `callback_id` to `_callback_id` inside the function body
- This ensures each callback closure captures its own copy of the callback ID at definition time

**Impact**:

- Fixes a real bug that would cause incorrect callback routing when multiple callbacks are passed in a single RPC call
- The bug was discovered during code review and confirmed to exist in the codebase
- No breaking changes to the API

**Future Considerations**:

- Consider adding a test case that specifically tests multiple callbacks in a single request to prevent regression
- Review other language implementations (Go, Rust) for similar closure-related issues
- Document this pattern in the Python interop README as a common pitfall
