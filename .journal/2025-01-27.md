# 2025-01-27

## Breaking Change: IoInterface Redesign for Transferable Objects Support

### Core Decision/Topic

Redesigned the `IoInterface` contract to support transferable objects and structured clone messaging, moving from centralized buffer handling to adapter-level data format conversion.

### Options Considered

1. **Keep centralized conversion** (main branch approach)

   - Pros: No breaking changes, simple for adapters
   - Cons: Can't support transferables, type contracts are unclear, hidden complexity

2. **Move conversion to adapters** (chosen approach)

   - Pros: Clean separation of concerns, enables transferables, explicit type contracts
   - Cons: Breaking change, requires adapter updates

3. **Hybrid approach with backward compatibility**
   - Pros: No breaking changes
   - Cons: Complex, maintains technical debt, unclear contracts

### Final Decision & Rationale

**Chose option 2**: Move data format conversion responsibility to adapters.

**Rationale:**

- Enables transferable objects feature (primary goal)
- Cleaner architecture with explicit responsibilities
- Better type safety and clearer contracts
- Follows separation of concerns principle
- Future-proofs for additional structured data types

### Key Changes Made

#### Interface Changes (BREAKING)

```typescript
// OLD
interface IoInterface {
	read(): Promise<Uint8Array | string | null>
	write(data: string): Promise<void>
}

// NEW
interface IoInterface {
	read(): Promise<string | IoMessage | null>
	write(message: string | IoMessage): Promise<void>
	capabilities?: IoCapabilities
}
```

#### Channel Changes

- Removed centralized `TextDecoder` buffer conversion
- Now expects clean string/IoMessage from adapters
- Added support for structured clone and transferable objects

#### Adapter Updates Required

- **WebSocket**: Added Buffer→string conversion in `onmessage` handlers
- **All adapters**: Must now handle their own data format conversion
- **New adapters**: Can declare capabilities for transferables

### Breaking Change Impact

**Severity: MAJOR** (requires major version bump)

**Affected:**

- All custom `IoInterface` implementations
- Any code depending on `Uint8Array` return type from `read()`
- Adapters that relied on centralized buffer conversion

**Migration Required:**

```typescript
// OLD adapter
async read(): Promise<Uint8Array | string | null> {
  const data = await this.source.read()
  return data // Could be Buffer/Uint8Array
}

// NEW adapter
async read(): Promise<string | IoMessage | null> {
  const data = await this.source.read()
  // Must convert to string here
  return typeof data === 'string' ? data : data.toString('utf-8')
}
```

### WebSocket Specific Issue

**Problem:** Node.js `ws` library returns `Buffer` objects, browser WebSocket returns strings.

**Root Cause:** The old design had a type lie - WebSocket adapter was typed as returning `string` but actually returned `Buffer` on server side.

**Solution:** Added explicit Buffer→string conversion in WebSocket adapters:

```typescript
// Works in both Node.js and browsers
if (typeof message === "object" && message !== null && "toString" in message) {
	message = message.toString("utf-8")
}
```

### Future Considerations

1. **Version Strategy**: This should be a **major version bump** (v2.0.0) due to breaking interface changes
2. **Migration Guide**: Need comprehensive migration documentation
3. **Adapter Ecosystem**: May need to update community adapters
4. **Type Safety**: Consider stricter typing for adapter capabilities
5. **Testing**: Ensure all adapters handle both Node.js and browser environments

### Technical Debt Resolved

- Eliminated hidden Buffer handling in channel
- Made data flow explicit and type-safe
- Enabled transferable objects feature
- Improved separation of concerns

### Lessons Learned

1. **Type contracts should be honest** - the old `string | Uint8Array` was misleading
2. **Breaking changes are sometimes necessary** for architectural improvements
3. **Environment differences** (Node.js vs browser) need explicit handling
4. **Centralized conversion** can hide important implementation details

---

_This entry documents the architectural decision to redesign IoInterface for transferable objects support, including the breaking change impact and migration requirements._
