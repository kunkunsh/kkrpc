# Journal Entry - 2026-01-17

## Core Decision/Topic

Implemented NATS adapter for kkrpc to add support for NATS messaging system alongside existing RabbitMQ, Kafka, and Redis Streams adapters.

## Options Considered

1. **NATS Core vs JetStream**: Decided to use NATS Core (publish/subscribe) for simplicity. JetStream provides persistence and more advanced features, but adds complexity. Core NATS is sufficient for bidirectional RPC and supports queue groups for load balancing.

2. **Subject naming convention**: Considered using `kkrpc.messages` as default subject (similar to RabbitMQ's routing key pattern). Chose this for consistency with other adapters.

3. **Queue group implementation**: NATS natively supports queue groups for load balancing. Implemented optional `queueGroup` parameter - when provided, enables load balancing; when omitted, all subscribers receive all messages (broadcast pattern).

## Final Decision & Rationale

Implemented a NATS adapter that:
- Uses NATS Core publish/subscribe for message routing
- Supports optional queue groups for load balancing
- Follows the established `IoInterface` pattern used by other adapters
- Includes bidirectional RPC communication support
- Uses dynamic imports for `@nats-io/transport-node` to avoid requiring it as a hard dependency

The decision to use Core NATS rather than JetStream was based on:
- Simplicity: No stream management overhead
- Sufficiency: Core NATS with queue groups meets all RPC requirements
- Familiarity: Pattern matches existing Redis Streams and RabbitMQ adapters

## Key Changes Made

### New Files
- `packages/kkrpc/src/adapters/nats.ts` - Core NATS adapter implementation (220 lines)
- `packages/kkrpc/nats.ts` - Entry point export
- `packages/kkrpc/__tests__/nats.test.ts` - Comprehensive test suite (189 lines, 8 tests)
- `docs/src/content/docs/examples/nats.md` - Full documentation (323 lines)

### Modified Files
- `packages/kkrpc/mod.ts` - Added NATS export
- `packages/kkrpc/package.json` - Added `./nats` entry point
- `packages/kkrpc/tsdown.config.ts` - Added nats.ts to build entries
- `packages/kkrpc/README.md` - Added NATS to transport table and example section
- `docker-compose.yml` - Added NATS service (already present per user)

### Technical Implementation Details

The NATS adapter follows the standard pattern:
```typescript
class NatsIO implements IoInterface {
  name = "nats-io"
  private messageQueue: string[] = []
  private resolveRead: ((value: string | null) => void) | null = null
  // Uses @nats-io/transport-node for Node.js runtime
  // Dynamic import to avoid hard dependency
}
```

Key features:
- Subject-based routing (default: `kkrpc.messages`)
- Optional queue groups for load balancing
- Connection promise pattern for async initialization
- Graceful shutdown with `__DESTROY__` signal
- Session ID generation for unique identification

## Future Considerations

1. **JetStream Support**: Could add optional JetStream persistence layer for scenarios requiring message durability
2. **Request/Reply Pattern**: NATS supports direct request/reply which could optimize RPC latency
3. **Deno Transport**: Currently uses Node transport; Deno transport (`@nats-io/transport-deno`) could be added for native Deno support
4. **Connection Pooling**: For high-throughput scenarios, connection pooling may be beneficial
