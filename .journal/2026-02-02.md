# Journal Entry - 2026-02-02

## 11:20 - Secure IPC Bridge Architecture Decision

### Core Decision/Topic

Refactored `createSecureIpcBridge` to use dependency injection pattern instead of directly importing from "electron" package. This eliminates the need for kkrpc to depend on Electron as a peer dependency.

### Options Considered

1. **Option A: Keep Electron as peerDependency (>=20.0.0)**

   - Pros: Simple, works out of the box
   - Cons: Forces non-Electron users to install Electron; version conflicts with newer/older Electron versions

2. **Option B: Use optional peerDependency**

   - Pros: Non-Electron users won't be forced to install
   - Cons: Still version-locked; future Electron API changes could break kkrpc

3. **Option C: Dependency Injection Pattern (Chosen)**
   - Pros: Version agnostic, works with any Electron version, zero dependency overhead
   - Cons: Slightly more verbose API (user must import electron themselves)

### Final Decision & Rationale

**Chosen: Option C - Dependency Injection**

The key insight is that kkrpc only needs a minimal interface from Electron's `ipcRenderer`:

```ts
interface IpcRendererInterface {
	send(channel: string, ...args: unknown[]): void
	on(channel: string, listener: (event: unknown, ...args: unknown[]) => void): void
	off(channel: string, listener: (event: unknown, ...args: unknown[]) => void): void
}
```

By accepting `ipcRenderer` as a parameter instead of importing it:

- Users control their own Electron version
- No peer dependency warnings for non-Electron users
- Future-proof against Electron API changes
- Follows the principle of "composition over inheritance"

### Key Changes Made

| File                                         | Change                                                                             |
| -------------------------------------------- | ---------------------------------------------------------------------------------- |
| `src/adapters/electron-ipc-preload.ts`       | Refactored to accept `ipcRenderer` as parameter; added `IpcRendererInterface` type |
| `package.json`                               | Removed `electron` from `peerDependencies` entirely                                |
| `examples/electron-demo/electron/preload.ts` | Updated to new API: `createSecureIpcBridge({ ipcRenderer, channelPrefix })`        |
| `docs/examples/electron.md`                  | Updated documentation with new usage pattern                                       |
| `README.md`                                  | Updated Electron preload examples                                                  |

### API Change

**Before:**

```ts
import { createSecureIpcBridge } from "kkrpc/electron-ipc"

createSecureIpcBridge({ channelPrefix: "kkrpc-" })
```

**After:**

```ts
import { contextBridge, ipcRenderer } from "electron"
import { createSecureIpcBridge } from "kkrpc/electron-ipc"

const securedIpcRenderer = createSecureIpcBridge({
	ipcRenderer,
	channelPrefix: "kkrpc-"
})

contextBridge.exposeInMainWorld("electron", {
	ipcRenderer: securedIpcRenderer
})
```

### Future Considerations

- The `IpcRendererInterface` should remain stable even if Electron changes their API
- If Electron makes breaking changes to ipcRenderer, users can adapt without waiting for kkrpc updates
- Consider documenting this pattern for other framework integrations (e.g., if we add Tauri-specific helpers)

---

## 11:45 - TypeScript Error Fixes

### Core Decision/Topic

Fixed 3 TypeScript errors that appeared during `bun tsc --noEmit`:

1. `__tests__/http.test.ts:8` - `Server` generic requires type argument
2. `src/adapters/nats.ts:67` - Invalid option `rewait` (should be `reconnectTimeWait`)
3. `src/adapters/electron-ipc-preload.ts:1` - Cannot find module 'electron'

### Key Changes

| File                                   | Fix                                                           |
| -------------------------------------- | ------------------------------------------------------------- |
| `__tests__/http.test.ts`               | Changed `let server: Server` to `let server: Server<unknown>` |
| `src/adapters/nats.ts`                 | Fixed typo: `rewait: 1000` → `reconnectTimeWait: 1000`        |
| `src/adapters/electron-ipc-preload.ts` | Resolved by removing electron import (see above refactor)     |

### Verification

- ✅ `bun tsc --noEmit` passes
- ✅ 119 tests pass
